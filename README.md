# RCAP-national-USASpending
This repository contains Python scripts used to conduct analysis of United States federal spending data downloaded from the publically available, U.S. Treasury Dept. run website USAspending.gov.
The analysis organizes federal spending using the Catalog of Federal Domestic Assistance (CFDA) numbers for each program. For additional details on the programs of interest for this project, see the ```Program Search_CFDAs.xlsx``` spreadsheet in this repository. This repository does not contain a completed application, nor is intended to be an out-of-the-box toolset. 

The goal for this code base was to create a table of location names and spending totals for multiple water-related programs, for the whole United States, from fiscal years 2000-2023. This table was used to create a GIS application, a webmap that details funding received across multiple programs for 2 decades by nearly 10,000 communites across the U.S.. 

This project was funded by EPA under the National Water Infrastructure Environmental Finance Center Program.

## Preparation for Analysis
In order to conduct analysis using the included scripts, data must first be downloaded from USAspending.gov. There are a variety of ways to do this, such as the Award Data Archive, or the Custom Award Data download page. Choose a set of data to suit your needs, and be patient. Once downloaded, decompressed, and organized, relevant paths, filenames, datatypes, and column indices can be updated throughout the included code (assuming a case where this repo is used as a starting point). This will require careful attention, as the existing source code is structured for the machine on which most development for this project took place. For example, the raw prime award data for this project was stored in a directory called 'AllTheData,' while subaward data was in a directory called 'SubawardFiles.' These directory names are hardcoded in the files included in this repository, and will need to be either replicated or updated.

Reference files are titled ```efc_functions.py``` and ```subs_functions.py```. Within these files, you will find lists of CFDA numbers, some relevant functions, a list of integers that represent the indices of columns of interest in the raw data, and a dict of column names and datatypes/simple conversion functions to pass to the object reading .csv data. Column indices, names, and datatypes should be re-confirmed each time new data is downloaded, since the format of the data is sometimes updated. The lists of CFDA numbers in the reference files are specific to the project that produced this code, which was focused on water infrastructure. As such, the included CFDA numbers are for programs that focus on water. 

### Prime awards and Subawards
This project analyzed multiple types of awards, both Prime awards and Subawards. These datasets had to be downloaded separately. Files in this repository are named to distinguish whether they focus on prime or subawards. The scripts used for analyzing subawards are named with the prefix ```subaward_processing```. The numerical order of these files represents the order in which they should be run. The reference file for subaward analysis is ```subs_functions.py``` and it contains the indices and datatypes for the subaward columns (they do not match the prime award indices and column names/types).

## Code
For Prime award analysis, the first script that should be run is ```first_sort_cfdas.py```, followed by ```nat_second_sort.py``` and then ```nat_third_sort.py```. For subaward analysis, the scripts should be run in numbered order. An aggregated prime award table is produced by ```nat_third_sort.py``` that is read in by ```subaward_processing_4.py```, in order to combine the dataframes from the prime awards, the subawards, and the EDA program (CFDA 11.3).

As published in this repo, the prime award processing scripts exclude the CFDA numbers for which subawards are analyzed. This was not originally the case, the primes had to be re-aggregated based on an updated CFDA list that excluded the CFDA numbers with subawards, so that those CFDA numbers (for State Revolving Fund (SRF) and Community Dev. Block Grant (CDBG) programs) wouldn't be double counted in the final output.
In the fourth subaward processing file, multiple dataframes are combined to produce a complete nation-wide table that incorporates both prime and subawards. In addition to the prime and subaward dataframes, there is an EDA dataframe. This references data for CFDA 11.3, which had to be handled separately because not all entries under the program are relevant, so the descriptions of each award needed to be filtered for the presence of water related keywords (see ```subs_functions.py``` for a list of water-related keywords). This was also the case for some of the subawards, specifically the CDBG subawards (list of CDBG CFDAs detailed in ```subs_functions.py```). The EDA keyword filtering took place in Excel, but the CDBG keyword filtering was handled in code, which can be seen in the second subaward processing file.

## Post-Processing
Some post-processing for this project took place in excel. The outputs from the pivot functions generate 2 rows of headers, which are easiest to flatten by hand. In addition to manual post processing in Excel, the included .R script was contributed by Lena Schlichting, to expand the CFDA numbers to include full program names, and format/clean data in preparation for use in the GIS applications that were the ultimate objective of this project.
